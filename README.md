# Real Estate Rental Network – Hyperledger Fabric

This document describes how to set up and run the Real Estate Rental Hyperledger Fabric network and provides details on its architecture, chaincode functionality, and usage.

## Overview

**Network Architecture:** The network consists of one ordering service organization (OrdererOrg) with 3 RAFT orderer nodes, and three peer organizations:
- **OrgProp** (Property owner/landlord organization) – 1 peer (with CouchDB state DB).
- **OrgTenant** (Tenant organization) – 1 peer (with CouchDB state DB).
- **OrgLandlord** (Broker/Landlord organization) – 1 peer (with CouchDB state DB).

All nodes have TLS enabled and identities are generated by Fabric CA (Certificate Authority). NodeOUs are enabled in MSPs to distinguish roles (peer, client, admin, orderer) via OU attributes in certificates. The network uses a single channel **`rentalchannel`** joined by all three peer orgs and the ordering service.

**Chaincode:** A smart contract named **`real-estate-cc`** (JavaScript, CommonJS module) implements the logic for managing property rentals:
- **Property** records (public world state): `{objectType: "property", propertyId, ownerOrgMSP, geoRef, status}` where `status` might be "AVAILABLE", "LEASED", etc.
- **Lease** records (public world state): `{objectType: "lease", leaseId, propertyId, parties: [OrgPropMSP, OrgTenantMSP, OrgLandlordMSP], status, pdcKey}`. The `parties` array identifies the participating orgs (landlord, tenant, landlord) by their MSP IDs. `pdcKey` is a reference key for private lease details.
- **Private Lease Terms** (in a Private Data Collection called **`leasePrivate`**): Stored off-ledger for sensitive information like rent amount, deposit, bank info, penalties, personally identifiable info hash (`piiHash`), etc. Example schema: `{leaseId, rent, deposit, bankInfo, penalties, piiHash, ...}`. The private data is shared among OrgProp, OrgTenant, and OrgLandlord (all parties).

**Private Data Collection (PDC):** A collection named **`leasePrivate`** is defined (see `collections_config.json`). It uses an endorsement policy `OR('OrgPropMSP.member','OrgTenantMSP.member','OrgLandlordMSP.member')` (so any one organization's peer can write the private data, and all three can read it). The collection requires at least 1 peer from the three to endorse (`requiredPeerCount=1`, `maxPeerCount=3`), with `memberOnlyRead/write=true` (only those orgs can read/write the data). `blockToLive=1000` specifies private data will persist for 1000 blocks on peers (beyond which only the hash remains on ledger).

**State-Based Endorsement (SBE):** The chaincode uses state-based endorsement to enforce that **updates to a lease record require endorsement from both the landlord and tenant organizations**. After a lease is created, the chaincode sets a key-level endorsement policy on that lease state (via `ctx.stub.setStateValidationParameter`) to `AND('OrgPropMSP.member','OrgTenantMSP.member')`. This means any future transaction modifying that lease must be endorsed by peers from OrgProp and OrgTenant, even though the chaincode’s overall endorsement policy (set at deployment) might be looser (by default we use `OR('OrgPropMSP.peer','OrgTenantMSP.peer','OrgLandlordMSP.peer')` for flexibility).

**Attribute-Based Access Control (ABAC):** The Fabric CA issues enrollment certificates with a `role` attribute for each user (set during registration). The chaincode checks the invoker’s attributes via `ctx.clientIdentity.getAttributeValue('role')` to restrict access:
- Only a user with `role=landlord` (from the property owner org) or `role=landlord` can create a new lease.
- Only a user with `role=tenant` can pay rent on a lease.
- Only authorized roles can update or terminate a lease (e.g., landlord or landlord for updates/termination).
These checks ensure only appropriate participants invoke certain transactions.

**Events:** The chaincode emits events to notify external applications of key lifecycle actions:
- `leaseCreated` – emitted after a new lease is successfully created (contains leaseId or other info).
- `rentPaid` – emitted when a rent payment transaction is processed.
- `leaseTerminated` – emitted upon lease termination.
Client applications can register to listen for these events and react (e.g., update UI, trigger off-chain processes).

**CouchDB Indexes:** To enable rich queries on CouchDB state database, the chaincode package includes index definitions:
- In `META-INF/statedb/couchdb/indexes/`: `idx_property_owner.json` (index on Property `ownerOrgMSP`), and `idx_lease_status.json` (index on Lease `status`). These optimize queries such as "find all properties owned by OrgProp" or "find all leases with status = 'ACTIVE'".
- In `META-INF/statedb/couchdb/collections/leasePrivate/indexes/`: `idx_leasePrivate_leaseId.json` (index on private data `leaseId`) and `idx_leasePrivate_rent.json` (index on `rent`). These allow efficient private data queries like range of rent amounts (if an organization queries its private data store).

## Prerequisites

- **Docker and Docker Compose:** Ensure Docker engine and docker-compose are installed.
- **Fabric Binaries:** The scripts use `fabric-ca-client`, `peer`, `configtxgen`, `osnadmin` CLI tools. You can install the Hyperledger Fabric binaries. For convenience, a `network/bootstrap.sh` script is provided to download the Fabric v2.5.12 binaries and docker images if not already available.
- **Node.js:** Required to run the client application (Node 18+ recommended).

## Usage Guide

Follow these steps to launch the network, deploy chaincode, and run the demo scenario:

### 1. Launch CAs and Generate Identities

Bring up the Certificate Authority (CA) containers for each organization and register/enroll all identities (orderers, peers, admins, application users):

```bash
cd network
./ca-up.sh        # Start CA servers for OrdererOrg, OrgProp, OrgTenant, OrgLandlord
./register-enroll.sh   # Register and enroll identities, generate MSP and TLS certs for all entities
